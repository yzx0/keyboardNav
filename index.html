<!DOCTYPE html>
<html lang="zh-Hans">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./style.css">
    <title>导航</title>
</head>

<body>
    <header></header>
    <main>
        <div class="vessel" id="vessel">

        </div>
    </main>
    <footer></footer>
    <script>
        //初始化数据
        var data = init()
        var key = data['key']
        var hash = data['hash']

        //生成键盘
        createKeyboard(key, hash)

        //监听用户键盘输入
        listenToUser(hash)

/************************************************/

        //初始化数据
        function init() {
            var key = {
                0: { 0: 'q', 1: 'w', 2: 'e', 3: 'r', 4: 't', 5: 'y', 6: 'u', 7: 'i', 8: 'o', 9: 'p', length: '10' },
                1: { 0: 'a', 1: 's', 2: 'd', 3: 'f', 4: 'g', 5: 'h', 6: 'j', 7: 'k', 8: 'l', length: '9' },
                2: { 0: 'z', 1: 'x', 2: 'c', 3: 'v', 4: 'b', 5: 'n', 6: 'm', length: '7' },
                length: '3'
            }
            var hash = {
                'q': 'qq.com',
                'w': 'weibo.com',
                'e': 'ele.me',
                'r': 'renren.com',
                't': 'tmall.com',
                'y': 'youtube.com',
                'u': 'uc.com',
                'i': 'iqiyi.com',
                'o': 'opera.com',
                'p': 'undefined',
                'a': 'acfun.com',
                'z': 'zhihu.com',
                'm': 'www.mcdonalds.com'
            }
            var hashLocalStorage = getFromLocalStorage('zzz')
            if (localStorage) {
                hash = hashLocalStorage
            }
            return {
                key: key,
                hash: hash
            }
        }

        function createKeyboard(key, hash) {
            //遍历key
            for (var index = 0; index < key['length']; index++) {
                //创建<div>
                var div1 = createTag('div', { className: 'row', id: 'row' })
                appendTag(vessel, div1)

                //获取key[x][y]
                var secondArr = key[index]
                //遍历key[x][y]
                for (var index2 = 0; index2 < secondArr['length']; index2++) {
                    //创建<kbd>
                    var myKeyboard = createTag('kbd')
                    appendTag(div1, myKeyboard)

                    //创建<span>
                    var span = createTag('span', { textContent: secondArr[index2] })
                    appendTag(myKeyboard, span)

                    //创建<button>
                    var editButton = createTag('button', { textContent: 'E', id: secondArr[index2] })
                    appendTag(myKeyboard, editButton)

                    //创建<img>    
                    var myImg = createTag('img')
                    appendTag(myKeyboard, myImg)

                    //处理img无法正常显示
                    imgProblemHandling(hash[secondArr[index2]], myImg)

                    //实现点击编辑功能
                    clickEdit(editButton);
                }
            }

        }
        //创建标签,设置标签属性
        function createTag(tagName, attributes) {
            var element = document.createElement(tagName)
            for (var key in attributes) {    //key是名为attributes的哈希的key。className ：xxx
                element[key] = attributes[key]
            }
            return element
        }

        //添加标签到父元素
        function appendTag(father, child) {
            return father.appendChild(child)
        }

        //获取LocalStorage
        function getFromLocalStorage(name) {
            return JSON.parse(localStorage.getItem(name) || 'null')
        }

        //处理如果对应域名不存在，图片无法显示问题
        function imgProblemHandling(domain, myImg) { //domain接收一个该域名对应的hash
            if (domain) {
                myImg.src = 'http://' + domain + '/favicon.ico'
            }
            else {
                myImg.src = './img/none.png'
            }
            myImg.onerror = function (imgInfo) {
                imgInfo.target.src = './img/none.png'
            }
        }

        //监听编辑按钮，实现点击编辑功能
        function clickEdit(editButton) {
            editButton.onclick = function (buttonInfo) {
                button = buttonInfo.target
                buttonId = buttonInfo.target.id
                newWebSite = prompt('请输入新的地址')
                hash[buttonId] = newWebSite
                img2 = button.nextSibling
                img2.src = 'http://' + newWebSite + '/favicon.ico'
                localStorage.setItem('zzz', JSON.stringify(hash))
            }
        }

        //监听用户键盘输入
        function listenToUser(domain) {
            document.onkeypress = function (buttonInfo) {
                domain = hash[buttonInfo.key]
                window.open('http://' + domain, '_blank')
            }
        }

    </script>
</body>

</html>